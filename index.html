<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3dproject.ve | Suite Financiera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --v-green: #1B3022; --v-light: #2D4A36; --v-soft: #385541; --gold: #C5A059; --white: #FDFCF8; }
        body { font-family: 'Inter', sans-serif; background-color: var(--v-green); color: var(--white); min-height: 100vh; }
        .card-pro { background: var(--v-light); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 16px; }
        .nav-link { cursor: pointer; color: rgba(253, 252, 248, 0.5); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; padding-bottom: 8px; border-bottom: 3px solid transparent; transition: 0.3s; }
        .nav-link.active { color: var(--gold); border-bottom: 3px solid var(--gold); opacity: 1; }
        input, select { background-color: rgba(27, 48, 34, 0.6)!important; border: 1px solid var(--v-soft)!important; border-radius: 10px; padding: 10px; color: white!important; width: 100%; outline: none; }
        input:focus { border-color: var(--gold)!important; }
        .btn-gold { background-color: var(--gold); color: var(--v-green); font-weight: 800; border-radius: 12px; transition: transform 0.2s; }
        .btn-gold:active { transform: scale(0.98); }
        .hidden { display: none; }
    </style>
</head>
<body class="pb-10 p-4">
    <div id="app" class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6 text-center md:text-left">
            <div>
                <h1 class="text-4xl font-black text-gold uppercase italic">3DPROJECT<span class="text-white">.VE</span></h1>
                <p class="text-[9px] font-bold opacity-40 tracking-widest uppercase">Manufactura & Finanzas</p>
            </div>
            <div class="flex gap-4 bg-[#2D4A36] p-4 rounded-xl border border-white/5 shadow-xl">
                <div class="text-right">
                    <p class="text-[8px] font-black text-gold/60 uppercase">Tasa BCV</p>
                    <input type="number" id="tasaBCV" value="48.50" step="0.01" class="w-20 bg-transparent! border-none! p-0 text-sm font-black text-right" oninput="updateAll()">
                </div>
                <div class="h-8 w-px bg-white/10"></div>
                <div class="text-right">
                    <p class="text-[8px] font-black text-gold/60 uppercase">Paralela</p>
                    <input type="number" id="tasaParalela" value="56.20" step="0.01" class="w-20 bg-transparent! border-none! p-0 text-sm font-black text-right" oninput="updateAll()">
                </div>
            </div>
        </header>

        <nav class="flex gap-8 border-b border-white/10 mb-8 overflow-x-auto no-scrollbar">
            <div onclick="switchTab('dashboard')" class="nav-link active" id="tab-dashboard">Dashboard</div>
            <div onclick="switchTab('cotizador')" class="nav-link" id="tab-cotizador">Cotizador</div>
            <div onclick="switchTab('finanzas')" class="nav-link" id="tab-finanzas">Libro Contable</div>
        </nav>

        <main>
            <section id="section-dashboard" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card-pro p-6 border-l-4 border-white">
                        <p class="text-[10px] uppercase opacity-50 font-bold">Balance Neto Real</p>
                        <h2 class="text-3xl font-black" id="dash-flujoNeto">$0.00</h2>
                    </div>
                    <div class="card-pro p-6 border-l-4 border-gold">
                        <p class="text-[10px] uppercase text-gold font-bold">Fondo Empresa (50%)</p>
                        <h2 class="text-3xl font-black" id="dash-fondo">$0.00</h2>
                    </div>
                    <div class="card-pro p-6 border-l-4 border-blue-400">
                        <p class="text-[10px] uppercase text-blue-400 font-bold">Material (10%)</p>
                        <h2 class="text-3xl font-black" id="dash-material">$0.00</h2>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card-pro p-8 border-l-4 border-green-500">
                        <p class="text-[10px] uppercase text-green-400 font-bold">Utilidad Personal (40%)</p>
                        <h2 class="text-5xl font-black" id="dash-utilidad">$0.00</h2>
                    </div>
                    <div class="card-pro p-8">
                        <h3 class="text-[10px] font-bold uppercase opacity-30 mb-4">Rendimiento Operativo</h3>
                        <div class="h-40"><canvas id="balanceChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section id="section-cotizador" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card-pro p-8 space-y-4">
                    <h3 class="text-xl font-black text-gold uppercase italic mb-4">Configurar Producción</h3>
                    <input type="text" id="q-cliente" placeholder="Nombre del Cliente" oninput="calculateQuote()">
                    <input type="text" id="q-pieza" value="Pieza 3D" oninput="calculateQuote()">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold opacity-50 uppercase">Horas</label>
                            <input type="number" id="q-horas" value="1" oninput="calculateQuote()">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold opacity-50 uppercase">Gramos</label>
                            <input type="number" id="q-gramos" value="25" oninput="calculateQuote()">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold opacity-50 uppercase">Costo $/kg</label>
                            <input type="number" id="q-costoMat" value="25" oninput="calculateQuote()">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold opacity-50 uppercase">Material</label>
                            <select id="q-material" onchange="calculateQuote()">
                                <option value="PLA">PLA</option>
                                <option value="PETG">PETG</option>
                                <option value="ABS">ABS</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gold uppercase">Utilidad: <span id="ganancia-val">100</span>%</label>
                        <input type="range" id="q-ganancia" min="10" max="300" value="100" oninput="calculateQuote()">
                    </div>
                </div>

                <div class="card-pro p-8 bg-black/20 border-2 border-gold flex flex-col justify-center items-center text-center">
                    <p class="text-xs uppercase text-gold font-black tracking-widest mb-2">Presupuesto Sugerido (BCV)</p>
                    <h2 class="text-7xl font-black mb-4" id="res-finalUSDBCV">$0.00</h2>
                    <h3 class="text-3xl font-bold text-white/90 mb-8" id="res-finalVES">Bs. 0.00</h3>
                    <button onclick="generatePDF()" class="w-full btn-gold py-5 uppercase text-sm shadow-lg">Descargar Cotización PDF</button>
                </div>
            </section>

            <section id="section-finanzas" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card-pro p-8 space-y-4">
                    <h3 class="text-xl font-black text-gold uppercase italic">Registrar Movimiento</h3>
                    <input type="text" id="f-desc" placeholder="Concepto (Ej: Venta Llaveros)">
                    <input type="number" id="f-monto" placeholder="Monto en USD">
                    <select id="f-tipo">
                        <option value="venta">Ingreso (+)</option>
                        <option value="gasto">Egreso (-)</option>
                    </select>
                    <button onclick="addMovimiento()" class="w-full btn-gold py-4 uppercase text-xs">Guardar Registro</button>
                </div>
                <div class="card-pro p-6">
                    <h3 class="text-sm font-black uppercase opacity-50 mb-4 italic">Historial Reciente</h3>
                    <div id="f-lista" class="space-y-2 max-h-80 overflow-y-auto pr-2 no-scrollbar"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let historial = [];
        let balanceChart;

        function switchTab(tabId) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav .nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('section-' + tabId).classList.remove('hidden');
            document.getElementById('tab-' + tabId).classList.add('active');
            if(tabId === 'dashboard') updateDashboard();
        }

        function updateAll() { calculateQuote(); updateDashboard(); }

        function calculateQuote() {
            const bcv = parseFloat(document.getElementById('tasaBCV').value) || 1;
            const para = parseFloat(document.getElementById('tasaParalela').value) || 1;
            const h = parseFloat(document.getElementById('q-horas').value) || 0;
            const g = parseFloat(document.getElementById('q-gramos').value) || 0;
            const cMat = parseFloat(document.getElementById('q-costoMat').value) || 0;
            const gan = parseFloat(document.getElementById('q-ganancia').value) || 0;

            document.getElementById('ganancia-val').innerText = gan;

            const costBase = ((g / 1000) * cMat) + (h * 0.65);
            const priceUSD = costBase * (1 + (gan / 100));
            const priceVES = priceUSD * para;
            const priceFinalBCV = priceVES / bcv;

            document.getElementById('res-finalUSDBCV').innerText = `$${priceFinalBCV.toFixed(2)}`;
            document.getElementById('res-finalVES').innerText = 'Bs. ' + priceVES.toLocaleString('es-VE', {minimumFractionDigits:2});
        }

        function addMovimiento() {
            const desc = document.getElementById('f-desc').value;
            const monto = parseFloat(document.getElementById('f-monto').value);
            const tipo = document.getElementById('f-tipo').value;
            if(!desc || isNaN(monto)) return;

            historial.push({ desc, monto, tipo, id: Date.now() });
            document.getElementById('f-desc').value = '';
            document.getElementById('f-monto').value = '';
            renderHistorial();
            updateDashboard();
        }

        function renderHistorial() {
            const lista = document.getElementById('f-lista');
            lista.innerHTML = historial.map(m => `
                <div class="flex justify-between items-center bg-black/20 p-3 rounded-lg border-l-4 ${m.tipo==='venta'?'border-green-500':'border-red-500'}">
                    <div>
                        <p class="text-xs font-bold uppercase">${m.desc}</p>
                        <p class="text-[9px] opacity-40">${new Date().toLocaleDateString()}</p>
                    </div>
                    <p class="font-black ${m.tipo==='venta'?'text-green-400':'text-red-400'}">${m.tipo==='venta'?'+':'-'} $${m.monto.toFixed(2)}</p>
                </div>
            `).reverse().join('');
        }

        function updateDashboard() {
            const ingresos = historial.filter(h => h.tipo === 'venta').reduce((a, b) => a + b.monto, 0);
            const egresos = historial.filter(h => h.tipo !== 'venta').reduce((a, b) => a + b.monto, 0);
            const neto = ingresos - egresos;

            document.getElementById('dash-flujoNeto').innerText = `$${neto.toFixed(2)}`;
            document.getElementById('dash-fondo').innerText = `$${(Math.max(0, neto) * 0.5).toFixed(2)}`;
            document.getElementById('dash-material').innerText = `$${(Math.max(0, neto) * 0.1).toFixed(2)}`;
            document.getElementById('dash-utilidad').innerText = `$${(Math.max(0, neto) * 0.4).toFixed(2)}`;
            updateChart(ingresos, egresos);
        }

        function updateChart(i, e) {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            if(balanceChart) balanceChart.destroy();
            balanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ingresos', 'Egresos'],
                    datasets: [{ data: [i, e], backgroundColor: ['#C5A059', '#1B3022'], borderColor: 'rgba(255,255,255,0.1)' }]
                },
                options: { plugins: { legend: { display: false } }, cutout: '80%' }
            });
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const cliente = document.getElementById('q-cliente').value || "Cliente";
            const totalUSD = document.getElementById('res-finalUSDBCV').innerText;
            const totalVES = document.getElementById('res-finalVES').innerText;

            doc.setFillColor(27, 48, 34);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(197, 160, 89);
            doc.setFontSize(22);
            doc.text("3DPROJECT.VE - COTIZACIÓN", 20, 25);
            
            doc.setTextColor(0,0,0);
            doc.setFontSize(12);
            doc.text(`Cliente: ${cliente}`, 20, 50);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 60);

            doc.autoTable({
                startY: 70,
                head: [['Concepto', 'Total USD (BCV)', 'Total BS (BCV)']],
                body: [[document.getElementById('q-pieza').value, totalUSD, totalVES]],
                headStyles: { fillColor: [27, 48, 34] }
            });

            doc.text("Términos: Pago 70% para iniciar. Tasa BCV del día.", 20, doc.lastAutoTable.finalY + 20);
            doc.save(`Cotizacion_${cliente}.pdf`);
        }

        window.onload = () => { updateAll(); };
    </script>
</body>
</html>
